---
title: JavaScript高级程序设计-26-最佳实践
categories: js
tags:
  - js
  - js-pro
date: 2016-09-20 13:49:47
updated:
---

js的最佳实践分成若干类，在开发过程的不同阶段上应用。

### 可维护性
复杂Web应用有成千上万行js，执行各种复杂功能。这不得不使开发者考虑可维护性问题。

编写可维护的代码很重要，因为大部分开发人员都花费大量时间维护他人代码，很难从头开始开发新代码，很多情况下是以他人的工作成果为基础的，确保自己的代码的可维护性，以便其他开发人员在此基础上更好的开展工作。

可维护的代码概念可以广泛应用在各种编程语言上，不仅仅是js。

#### 什么是可维护的代码
可维护的代码有一些特征，一般来说，需要遵循以下特点：
- 可理解性，其他人可以接手代码并理解它的意图和一般途径，而需要开发人员的完整解释
- 直观性，代码中的东西一看就能明白，不管其操作过程多么复杂
- 可适应性，代码以一种数据上变化不要求完全重写的方法撰写
- 可扩展性，在代码架构上已考虑到在未来允许对核心功能进行扩展
- 可调试性，当出错时，代码可以给予足够的信息来尽可能直接的确定问题所在。

#### 代码约定
让代码变得可维护的简单途径是形成一套js代码的书面约定，绝大多数语言都开发出各自的代码约定，网上一搜就很多相关文档。比如专业组织为开发者指定了详细的代码约定让代码对任何人都可维护，优秀开源项目有着严格的代码要求，让社区的任何人偶可以轻松的理解代码是如何组织的。

由于js的可适应性，代码约定很重要，由于和大多数面向对象语言不同，js不强制开发人员将所有东西都定义为对象，语言可以支持各种编程风格，从传统面向对象式到声明式到函数式。不同的开源库就有可能使用不同的创建对象、定义方法、管理环境的方式。

##### 可读性
要让代码可维护，首先必须可读，可读性与代码作为文本文件的格式化方式有关，可读性的大部分内容都是和代码的缩进相关的，当所有代码缩进一致时整个项目中的代码才会更容易阅读。通常会使用若干空格而非制表符来进行缩进，因为制表符在不同的文本编辑器内显示效果不同，推荐4个空格。

可读性的另一方面是注释，在大多数编程语言中，对每个方法注释视为一个可行的实践，因为js可以在代码的任何地方创建函数，所以这点常常被忽略了，但正因为如此，在js中为每个函数编写文档就更重要了，一般而言，如下的地方需要进行注释：
- 函数和方法，每个函数或方法都需要一个注释，描述其目的和用于完成任务可能使用的算法，陈诉假设也非常作业，如参数代码什么，函数是否有返回值（因为不能从函数定义推断出来）。
- 大段代码，用于完成单个任务的多行代码应该在前面放一个描述任务的注释。
- 复杂算法，若使用了一个独特的方式解决问题，则要在注释中解释你是如何做的，这样不仅可帮助其他浏览代码的人，也方便下次自己查阅代码帮助理解。
- Hack，因为存在浏览器差异，js代码一般会包含一些hack，不要假设其他人在查看代码时能够理解hack所解决的问题，那么将信息放在注释中，能减少别人误删改的情况。

缩进和注释都可以带来更可读的代码，在未来则更容易维护。

##### 变量和函数命名
适当给变量和函数起名字对于增加代码可读性和可维护性非常重要。命名的一般规则如下：
- 变量名应该是名词
- 函数名应该以动词开始，返回布尔值类型的函数一般以is开头
- 变量和函数都应使用合乎逻辑的名字，不用担心长度，长度问题可以通过后处理和压缩来缓解
必须避免出现无法表示所包含的数据类型的无用变量名，有了合适的命名，代码阅读起来就像讲述故事一样，更容易理解。

##### 变量类型透明
由于js中变量是松散类型，很容易就忘记变量所应包含的数据类型，合适的命名方式可以一定程度上环境这个问题，但放到所有的情况下看，还不够，有三种表示变量数据类型的方式。

第一个是初始化，当定义了一个变量后，它应该初始化为一个值，暗示它将来应该如何应用，例如，将来保存布尔类型值的变量应该初始化为true或false，将来保存数字的变量初始化为一个数字。

初始化为一个特定的数据类型可以很好的指明变量的类型，但缺点是它无法用于函数声明中的函数参数。

第二种是使用匈牙利标记发来指定变量类型，即在变量名前加上一个或多个字符来表示数据类型。比如：o表示对象，s表示字符串，i表示整数，f表示浮点数，b表示布尔值。
```js
var iCount = 1; // 整数
var oPerson = {}; // 对象
```
好处是，函数参数一样可以使用，但缺点是让代码某种程度上难以阅读，阻碍了代码的直观性和句子式的特质。

最后一种指定变量类型的方式是使用类型注释，类型注释放在变量名右边，但在初始化前面，这种方式是在变量旁边放一段指定类型的注释：
```js
var count /*:int*/ = 1; 
var person; /*:object*/ = null;
```
类型注释维持了代码整体的可读性，同时注入了类型信息，类型注释的缺点是你不能用多行注释依次注释大块的代码，因为类型注释也是多行注释，两者会冲突。

三种方式各有优缺点、可自行确定那种最适合项目并一致使用。

#### 松散耦合
只要应用的某个部分过渡依赖于另一部分，代码就是耦合过紧，难以维护，典型的问题如：对象直接引用另一个对象，并且当修改其中一个的同时需要修改另一个，紧密耦合的软件难以维护并且常常需要重写。

而Web所用的技术有多种情况会使它耦合过紧，必须小心，尽可能采用若耦合的方式：

##### 解耦HTML/JS
在Web中，HTML和js各自代表了解决方案中的不同层次，HTML是数据，js是行为，因为它们天生需要交互，所有有多种不同的方法将其关联起来，但一些方法会将HTML和js过于紧密的耦合在一起。比如直接写在HTML中的js，使用包含内联代码的script标签或使用html属性来分配事件处理程序。

当HTML和js过于紧密的耦合在一起时，出现js错误就要先判断错误是出现在HTML部分还是在js文件中，同时还会引入和代码是否可用的相关问题。而且对行为的修改需要同时触及HTML和js，因此影响了可维护性，而这些更改本该只在js中进行。

理想的情况下HTML和js应该完全分离，并通过外部文件和通过DOM注册行为来包含js。

HTML和js的紧密耦合也可以在相反的关系上成立，js包含HTML，通常是通过innerHTML插入HTML文本到页面上。

一般来说，应该避免在js中创建大量的HTML，HTML呈现应该尽可能与js分离，当用js插入数据时，尽量不要直接插入html标记，而是预先写好隐藏在页面内，使用js显示。

将HTML和js解耦可以在调试过程中节省时间，更容易定位错误，减轻维护难度。修改行为只在js中进行，更改标记只在渲染文件中。

##### 解耦CSS/JS
解耦CSS/JS常常是通过js修改样式类名（class名），而非直接修改样式本身，即只修改类名不修改样式信息，样式信息预先定义在class中。

由于IE中CSS可以通过表达式嵌入js，这会导致维护困难，所以避免使用这种方式。

##### 解耦逻辑/事件处理程序
Web一般都很相当多的事件处理程序、监听着无数的事件，但很难彻底将逻辑从事件处理程序分离，例如：
```js
function handleKeyPress(event){
  event = EventUtil.getEvent(event);
  if(event.keyCode == 13){
    var target = EventUtil.getTarget(event);
    var value = 5 * parseInt(target.value);
    if(value > 10){
      document.getElementById('errmsg').style.display = 'block';
    }
  }
}
```


